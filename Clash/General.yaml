# 通用设置

# 混合端口
# HTTP(S) 和 SOCKS 代理混合端口
mixed-port: 7893

# 允许局域网连接
allow-lan: true
bind-address: '*' # 绑定所有地址

# 运行模式
mode: rule

# 日志级别
# 可选：silent/error/warning/info/debug
log-level: info

# IPv6 支持
# 关闭后将阻断所有 IPv6 链接和屏蔽 DNS 请求 AAAA 记录
ipv6: false

# API 控制端口
external-controller: 127.0.0.1:9090

# 出站接口
# 多网卡环境可指定出站网卡
# interface-name: eth0

# 性能设置

# 统一延迟计算
# 去除握手等干扰，更准确反映节点延迟
unified-delay: true

# TCP 并发
# 使用最快握手的 IP，将并发连接所有 IP
tcp-concurrent: true

# 全局 TLS 指纹
# 防探测，优先低于 proxy 内的 client-fingerprint
# 可选："chrome","firefox","safari","ios","random","none"
global-client-fingerprint: chrome

# 进程匹配模式
# always - 开启，强制匹配所有进程
# strict - 默认，由 mihomo 判断是否开启
# off - 不匹配进程，推荐在路由器上使用此模式
find-process-mode: strict

# 连接设置

# TCP Keep-Alive 间隔
keep-alive-interval: 30

# GeoData 设置

# 规则库自动更新
geo-auto-update: true
geo-update-interval: 24 # 更新间隔（小时）

# GeoData 下载地址
geox-url:
  geoip: "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geoip.dat"
  geosite: "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geosite.dat"
  mmdb: "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/Country.mmdb"

# Hosts 设置
# 类似于 /etc/hosts，仅支持配置单个 IP
hosts:
  '*.clash.dev': 127.0.0.1
  '.dev': 127.0.0.1
  'localhost': 127.0.0.1

# 配置持久化

# 保存节点选择与 Fake-IP 映射
profile:
  store-selected: true
  store-fake-ip: true

# 流量嗅探

# 提升域名识别能力
sniffer:
  enable: true
  # 全局配置，优先级低于 sniff 内的实际配置
  override-destination: false
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true # 覆盖全局配置
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]

# DNS 设置

dns:
  enable: true
  listen: 0.0.0.0:1053
  ipv6: false # 不返回 AAAA 记录

  # Fake-IP 模式
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16

  # DNS 缓存算法
  # lru - 最近最少使用
  # arc - 自适应缓存替换（推荐）
  cache-algorithm: arc

  # DNS 缓存大小
  # 默认 1024，可根据需要调整
  cache-size: 4096

  # HTTP/3 支持
  # 国内 DoH 服务器对 H3 支持不稳定，建议关闭
  prefer-h3: false

  # 遵循分流规则
  # false（推荐）- DNS 服务器直连，性能最优
  # true - DNS 服务器遵守 rules 规则
  respect-rules: false

  # Fake-IP 过滤列表
  # 匹配的域名返回真实 IP，解决特定应用兼容性问题
  fake-ip-filter:
    # 局域网与本地服务
    - '*.lan'
    - '*.local'
    - '*.localdomain'
    - '*.home.arpa'
    - '*.localhost'
    - 'localhost.ptlogin2.qq.com'
    - 'WORKGROUP'
    # STUN 服务
    - '+.stun.*'
    - '*.srv.nintendo.net'
    - 'xbox.*.microsoft.com'
    - 'xbox.*.*.microsoft.com'
    - '*.xboxlive.com'
    # 网络检测
    - '*.msftconnecttest.com'
    - '*.msftncsi.com'
    - 'connectivitycheck.gstatic.com'
    - 'connectivitycheck.android.com'
    - 'connectivitycheck.platform.hicloud.com'
    - 'connect.rom.miui.com'
    - 'captive.apple.com'
    - 'network-test.debian.org'
    - 'detectportal.firefox.com'
    # 特殊服务
    - 'lens.l.google.com'
    - '*.mcdn.bilivideo.cn'
    - '*.battlenet.com.cn'
    - '*.battlenet.com'
    - '*.blzstatic.cn'
    - '*.battle.net'
    # Steam
    - '*.cm.steampowered.com'
    - '*.steamcontent.com'
    # Tailscale / ZeroTier
    - '*.tailscale.com'
    - '*.zerotier.com'
    # Spotify
    - '*.spotify.com'

  # Fake-IP 过滤模式
  # blacklist - 黑名单，匹配则不返回 fake-ip
  # whitelist - 白名单，仅匹配才返回 fake-ip
  fake-ip-filter-mode: blacklist

  # Bootstrap DNS
  # 用于解析 DNS 服务器域名，必须使用纯 IP
  default-nameserver:
    - 223.5.5.5
    - 119.29.29.29

  # 主 DNS 服务器
  # 配置为国内 DNS，确保国内域名获得最优 CDN
  nameserver:
    - https://dns.alidns.com/dns-query
    - https://doh.pub/dns-query

  # 域名分流策略
  # 根据域名类型使用不同的 DNS 服务器
  nameserver-policy:
    # 私有域名
    "geosite:private":
      - system
    # 广告拦截
    "geosite:category-ads-all": rcode://success
    # CDN 优化域名
    "+.apple.cn,+.icloud.com.cn":
      - https://dns.alidns.com/dns-query
    "+.taobao.com,+.tmall.com,+.alicdn.com,+.aliyun.com,+.alipay.com":
      - https://dns.alidns.com/dns-query
    "+.qq.com,+.tencent.com,+.weixin.com,+.gtimg.cn":
      - https://doh.pub/dns-query
    "+.jd.com,+.bilibili.com,+.hdslb.com,+.163.com,+.netease.com":
      - https://dns.alidns.com/dns-query
    "+.baidu.com,+.bdstatic.com,+.baidupcs.com":
      - https://dns.alidns.com/dns-query
    "+.douyin.com,+.toutiao.com,+.bytedance.com,+.douyincdn.com":
      - https://dns.alidns.com/dns-query
    "+.xiaohongshu.com,+.xhscdn.com,+.kuaishou.com":
      - https://dns.alidns.com/dns-query
    "+.meituan.com,+.pinduoduo.com":
      - https://dns.alidns.com/dns-query
    # 国内域名
    "geosite:cn":
      - https://dns.alidns.com/dns-query
      - https://doh.pub/dns-query
    # 国外域名（启用 HTTP/3）
    "geosite:geolocation-!cn":
      - https://dns.cloudflare.com/dns-query#h3=true
      - https://dns.google/dns-query#h3=true

# TUN 设置

tun:
  enable: true

  # 网络栈模式
  # system - 性能最高，兼容性一般
  # gvisor - 兼容性好，性能较低
  # mixed - TCP 走系统栈，UDP 走 gvisor（推荐）
  stack: mixed

  # DNS 劫持
  dns-hijack:
    - any:53

  # 自动设置路由
  auto-route: true

  # 自动检测出口网卡
  auto-detect-interface: true

  # 严格路由
  # 开启后设备将无法被其他设备访问
  # Android 建议开启，防止流量泄露
  # strict-route: false

  # 排除路由
  # 这些网段不经过 TUN，直接走物理网卡
  # route-exclude-address:
  #   - 192.168.31.0/24
